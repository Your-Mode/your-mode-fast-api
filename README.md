# Your Mode Fast API - ChatAgent

## 개요

ChatAgent는 LangGraph를 사용하여 구조화된 대화를 관리하는 챗봇 시스템입니다. 질문-답변-검증-응답/재질문의 완전한 사이클을 UUID 기반으로 관리합니다.

## 아키텍처

### 핵심 컴포넌트

- **ChatAgentState**: 대화 상태를 담는 Pydantic 모델
- **ChatAgent**: LangGraph 기반의 대화 관리 클래스
- **외부 상태 관리**: `external_answers`, `question_callbacks`, `conversation_states`
- **LangGraph**: 상태 기반 워크플로우 관리
- **UUID 기반 식별**: 각 대화마다 고유한 `thread_id` 할당

## LangGraph 워크플로우 구조

```
                    ┌─────────────────┐
                    │     START       │
                    └─────────┬───────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  ask_question   │
                    │  (질문 제시)     │
                    │                 │
                    │ • 질문을 state에 저장
                    │ • current_status = "question_asked"
                    │ • 외부로 질문 전송 (콜백)
                    │ • 대화 내역에 질문 기록
                    └─────────┬───────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ wait_for_answer │
                    │ (답변 대기/수집) │
                    │                 │
                    │ • 외부 저장소에서 답변 확인
                    │ • 답변이 있으면: answer_received
                    │ • 답변이 없으면: waiting_answer
                    │ • 대화 내역에 답변 기록
                    └─────────┬───────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │ _route_after_wait│ ← 답변 대기 상태 확인
                    │ (답변 대기 상태 확인)│
                    └─────────┬───────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
                    ▼                   ▼
        ┌─────────────────┐   ┌─────────────────┐
        │   "waiting"     │   │"answer_received"│
        │   (계속 대기)    │   │   (답변 수신)   │
        │                 │   │                 │
        └─────┬───────────┘   └─────────┬───────┘
              │                         │
              │                         ▼
              │               ┌─────────────────┐
              │               │validate_answer  │
              │               │ (답변 검증)     │
              │               │                 │
              │               │ • answer_received 상태일 때만 검증
              │               │ • valid/invalid 판정
              │               └─────────┬───────┘
              │                         │
              │                         ▼
              │               ┌─────────────────┐
              │               │_route_after_val │
              │               │ (검증 후 라우팅) │
              │               └─────────┬───────┘
              │                         │
              │               ┌─────────┴─────────┐
              │               │                   │
              │               ▼                   ▼
              │     ┌─────────────────┐ ┌─────────────────┐
              │     │   "valid"       │ │   "invalid"     │
              │     │   (유효한 답변)  │ │   (유효하지 않은 답변)│
              │     │                 │ │                 │
              │     └─────┬───────────┘ └─────────┬───────┘
              │           │                       │
              │           ▼                       ▼
              │ ┌─────────────────┐   ┌─────────────────┐
              │ │generate_chatbot │   │handle_invalid   │
              │ │_response        │   │_answer          │
              │ │(챗봇 응답 생성)  │   │(에러 처리/가이드)│
              │ │                 │   │                 │
              │ │ • 챗봇 응답 생성 │   │ • 재시도 횟수 증가
              │ │ • 대화 내역에 기록│   │ • 에러 메시지 기록
              │ │                 │   │ • max_retries 확인
              │ └─────────┬───────┘   └─────────┬───────┘
              │           │                       │
              │           │                       ▼
              │           │               ┌─────────────────┐
              │           │               │   ask_question  │
              │           │               │   (재질문)      │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │ wait_for_answer │
              │           │               │ (답변 대기)     │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │ _route_after_wait│
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │   "waiting"     │
              │           │               │   (계속 대기)    │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │ wait_for_answer │
              │           │               │ (무한 루프 방지) │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │ _route_after_wait│
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │   "timeout"     │
              │           │               │   (타임아웃)    │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │handle_invalid   │
              │           │               │_answer          │
              │           │               │(타임아웃 처리)   │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │   ask_question  │
              │           │               │   (다음 질문)   │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │ wait_for_answer │
              │           │               │ (새 질문 대기)  │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │ _route_after_wait│
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │"answer_received"│
              │           │               │   (답변 수신)   │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │validate_answer  │
              │           │               │ (답변 검증)     │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │_route_after_val │
              │           │               │ (검증 후 라우팅) │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │   "valid"       │
              │           │               │   (유효한 답변)  │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │generate_chatbot │
              │           │               │_response        │
              │           │               │(챗봇 응답 생성)  │
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │   save_answer   │
              │           │               │ (답변 저장)     │
              │           │               │                 │
              │           │               │ • 대화 내역에 성공 기록
              │           │               │ • 다음 단계로 진행
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │check_completion │
              │           │               │ (완료 확인)     │
              │           │               │                 │
              │           │               │ • 모든 질문 완료 확인
              │           │               │ • 다음 질문으로 이동
              │           │               │ • 완료 시 종료
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────────────┐
              │           │               │_route_after_save│
              │           │               │ (저장 후 라우팅)│
              │           │               └─────────┬───────┘
              │           │                         │
              │           │                         ▼
              │           │               ┌─────────┴─────────┐
              │           │               │                   │
              │           │               ▼                   ▼
              │           │     ┌─────────────────┐ ┌─────────────────┐
              │           │     │   "continue"    │ │   "completed"   │
              │           │     │   (계속)        │ │   (완료)        │
              │           │     │                 │ │                 │
              │           │     └─────┬───────────┘ └─────────┬───────┘
              │           │           │                       │
              │           │           │                       │
              │           │           ▼                       ▼
              │           │ ┌─────────────────┐       ┌─────────────────┐
              │           │ │   ask_question  │       │       END       │
              │           │ │ (다음 질문)     │       │   (그래프 종료)  │
              │           │ └─────────┬───────┘       └─────────────────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │ wait_for_answer │
              │           │ │ (새 질문 대기)  │
              │           │ └─────────┬───────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │ _route_after_wait│
              │           │ └─────────┬───────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │"answer_received"│
              │           │ │   (답변 수신)   │
              │           │ └─────────┬───────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │validate_answer  │
              │           │ │ (답변 검증)     │
              │           │ └─────────┬───────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │_route_after_val │
              │           │ │ (검증 후 라우팅)│
              │           │ └─────────┬───────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │   "valid"       │
              │           │ │   (유효한 답변)  │
              │           │ └─────────┬───────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │generate_chatbot │
              │           │ │_response        │
              │           │ │(챗봇 응답 생성)  │
              │           │ └─────────┬───────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │   save_answer   │
              │           │ │ (답변 저장)     │
              │           │ └─────────┬───────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │check_completion │
              │           │ │ (완료 확인)     │
              │           │ └─────────┬───────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │_route_after_save│
              │           │ │ (저장 후 라우팅)│
              │           │ └─────────┬───────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │   "completed"   │
              │           │ │   (완료)        │
              │           │ └─────────┬───────┘
              │           │           │
              │           │           ▼
              │           │ ┌─────────────────┐
              │           │ │       END       │
              │           │ │   (그래프 종료)  │
              │           │ └─────────────────┘
```