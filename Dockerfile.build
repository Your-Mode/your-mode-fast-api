# 1) 베이스 이미지
FROM public.ecr.aws/lambda/python:3.12 AS base

# 2) Layer 빌드
FROM base AS layer-builder
RUN microdnf install -y zip \
 && pip install --upgrade pip \
 && pip install pydantic-core fastapi pydantic openai tiktoken --target /layer/python
WORKDIR /layer
RUN zip -9 -r /layer.zip python

# 3) Function 빌드
FROM base AS func-builder
RUN microdnf install -y zip \
 && pip install --upgrade pip
COPY requirements.txt /var/task/requirements.txt
RUN pip install -r /var/task/requirements.txt --target /package
COPY app /package/app
WORKDIR /package
RUN zip -9 -r /function.zip .

# 4) artifacts: layer.zip, function.zip 을 최종 이미지에 포함
FROM scratch AS artifacts
COPY --from=layer-builder /layer.zip /layer.zip
COPY --from=func-builder /function.zip /function.zip
CMD ["true"]