# Dockerfile.build

# 1) 베이스 이미지
FROM public.ecr.aws/lambda/python:3.12 AS base

# 2) Layer 빌드 스테이지
FROM base AS layer-builder
RUN pip install --upgrade pip \
 && pip install fastapi pydantic openai tiktoken -t /layer/python
WORKDIR /layer
RUN zip -9 -r /layer.zip python

# 3) Function 빌드 스테이지
FROM base AS func-builder

# ── 여기서 requirements.txt를 복사해 줘야 합니다 ──
# (빌드 컨텍스트: 레포 루트가 /var/task에 매핑된 상태)
COPY requirements.txt /var/task/requirements.txt

RUN pip install --upgrade pip \
 && pip install -r /var/task/requirements.txt -t /package

COPY app /package/app
WORKDIR /package
RUN zip -9 -r /function.zip .

# artifacts(layer.zip, function.zip) 를 docker cp로 꺼내어 사용
