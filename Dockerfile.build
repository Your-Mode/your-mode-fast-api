# Dockerfile.build

# 1) 베이스 이미지 (Lambda Python 3.12 on Amazon Linux 2 x86_64)
FROM public.ecr.aws/lambda/python:3.12 AS base

# 2) Layer 빌드 스테이지
FROM base AS layer-builder
# 필요 툴(zip)과 pydantic-core 등 C-extension 설치
RUN yum install -y zip \
 && pip install --upgrade pip \
 && pip install fastapi pydantic openai tiktoken -t /layer/python

WORKDIR /layer
RUN zip -9 -r /layer.zip python

# 3) Function 빌드 스테이지
FROM base AS func-builder
# zip 설치 및 Python 의존성 설치
RUN yum install -y zip \
 && pip install --upgrade pip \
 && pip install -r requirements.txt -t /package

# 애플리케이션 코드 복사
COPY app /package/app

WORKDIR /package
# zip 패키징
RUN zip -9 -r /function.zip .

# artifacts(layer.zip, function.zip)은 `docker cp`로 꺼내갑니다
